group_by(manager_id) %>%
summarise(high = sum(dummy))
medium_df <- tmp_df %>%
filter(interest_level == 'medium') %>%
group_by(manager_id) %>%
summarise(medium = sum(dummy))
low_df <- tmp_df %>%
filter(interest_level == 'low') %>%
group_by(manager_id) %>%
summarise(low = sum(dummy))
total_df <- tmp_df %>%
group_by(manager_id) %>%
summarise(total = sum(dummy))
tmp1_df <- total_df %>%
left_join(high_df) %>%
left_join(medium_df) %>%
left_join(low_df)
for(lev in levels(tmp_df$interest_level)){
tmp1_df[is.na(tmp1_df[, lev]), lev] <- 0
}
tmp2_df <- tmp1_df %>%
mutate(high_ratio = high/total, medium_ratio = medium/total,
low_ratio = low/total)
}
interest_by_manager <- function(df1, target_id){
tmp_df <- df1[, c(target_id, "interest_level")]
tmp_df$dummy <- 1
high_df <- tmp_df %>%
filter(interest_level == 'high') %>%
group_by(manager_id) %>%
summarise(high = sum(dummy))
medium_df <- tmp_df %>%
filter(interest_level == 'medium') %>%
group_by(manager_id) %>%
summarise(medium = sum(dummy))
low_df <- tmp_df %>%
filter(interest_level == 'low') %>%
group_by(manager_id) %>%
summarise(low = sum(dummy))
total_df <- tmp_df %>%
group_by(manager_id) %>%
summarise(m_total = sum(dummy))
tmp1_df <- total_df %>%
left_join(high_df) %>%
left_join(medium_df) %>%
left_join(low_df)
for(lev in levels(tmp_df$interest_level)){
tmp1_df[is.na(tmp1_df[, lev]), lev] <- 0
}
tmp2_df <- tmp1_df %>%
mutate(m_high = high/m_total, m_medium = medium/m_total,
m_low = low/m_total)
}
interest_by_building <- function(df1, target_id){
tmp_df <- df1[, c(target_id, "interest_level")]
tmp_df$dummy <- 1
high_df <- tmp_df %>%
filter(interest_level == 'high') %>%
group_by(building_id) %>%
summarise(high = sum(dummy))
medium_df <- tmp_df %>%
filter(interest_level == 'medium') %>%
group_by(building_id) %>%
summarise(medium = sum(dummy))
low_df <- tmp_df %>%
filter(interest_level == 'low') %>%
group_by(building_id) %>%
summarise(low = sum(dummy))
total_df <- tmp_df %>%
group_by(building_id) %>%
summarise(b_total = sum(dummy))
tmp1_df <- total_df %>%
left_join(high_df) %>%
left_join(medium_df) %>%
left_join(low_df)
for(lev in levels(tmp_df$interest_level)){
tmp1_df[is.na(tmp1_df[, lev]), lev] <- 0
}
tmp2_df <- tmp1_df %>%
mutate(b_high = high/b_total, b_medium = medium/b_total,
b_low = low/b_total)
}
manager_df <- interest_by_manager(train, 'manager_id')
manager_df
interest_by_manager <- function(df1, target_id){
tmp_df <- df1[, c(target_id, "interest_level")]
tmp_df$dummy <- 1
high_df <- tmp_df %>%
filter(interest_level == 'high') %>%
group_by(manager_id) %>%
summarise(high = sum(dummy))
medium_df <- tmp_df %>%
filter(interest_level == 'medium') %>%
group_by(manager_id) %>%
summarise(medium = sum(dummy))
low_df <- tmp_df %>%
filter(interest_level == 'low') %>%
group_by(manager_id) %>%
summarise(low = sum(dummy))
total_df <- tmp_df %>%
group_by(manager_id) %>%
summarise(m_total = sum(dummy))
tmp1_df <- total_df %>%
left_join(high_df) %>%
left_join(medium_df) %>%
left_join(low_df)
for(lev in levels(tmp_df$interest_level)){
tmp1_df[is.na(tmp1_df[, lev]), lev] <- 0
}
tmp2_df <- tmp1_df %>%
mutate(m_high = high/m_total, m_medium = medium/m_total,
m_low = low/m_total) %>%
select(manager_id, m_high, m_medium, m_low)
}
interest_by_building <- function(df1, target_id){
tmp_df <- df1[, c(target_id, "interest_level")]
tmp_df$dummy <- 1
high_df <- tmp_df %>%
filter(interest_level == 'high') %>%
group_by(building_id) %>%
summarise(high = sum(dummy))
medium_df <- tmp_df %>%
filter(interest_level == 'medium') %>%
group_by(building_id) %>%
summarise(medium = sum(dummy))
low_df <- tmp_df %>%
filter(interest_level == 'low') %>%
group_by(building_id) %>%
summarise(low = sum(dummy))
total_df <- tmp_df %>%
group_by(building_id) %>%
summarise(b_total = sum(dummy))
tmp1_df <- total_df %>%
left_join(high_df) %>%
left_join(medium_df) %>%
left_join(low_df)
for(lev in levels(tmp_df$interest_level)){
tmp1_df[is.na(tmp1_df[, lev]), lev] <- 0
}
tmp2_df <- tmp1_df %>%
mutate(b_high = high/b_total, b_medium = medium/b_total,
b_low = low/b_total) %>%
select(building_id, b_high, b_medium, b_low)
}
manager_df <- interest_by_manager(train, 'manager_id')
manager_df
summary(manager_df$m_high)
building_df <- interest_by_building(train, 'building_id')
building_df
train1 <- train %>%
left_join(manager_df) %>%
left_join(building_df)
names(train1)
valid1 <- valid %>%
left_join(manager_df) %>%
left_join(building_df)
sum(is.na(valid1$m_high))
sum(is.na(valid1$m_low))
nrow(valid1)
train <- train %>%
left_join(manager_df) %>%
left_join(building_df)
valid <- valid %>%
left_join(manager_df) %>%
left_join(building_df)
names(train)
table(train$interest_level)
table(train$interest_level)
tab <- table(train$interest_level)
tab
sum(tab)
tab[1]
tab <- table(train$interest_level)
valid[is.na(valid$m_low), 'm_low'] <- tab[1] / sum(tab)
valid[is.na(valid$m_medium), 'm_medium'] <- tab[2] / sum(tab)
valid[is.na(valid$m_high), 'm_high'] <- tab[3] / sum(tab)
valid[is.na(valid$b_low), 'b_low'] <- tab[1] / sum(tab)
valid[is.na(valid$b_medium), 'b_medium'] <- tab[2] / sum(tab)
valid[is.na(valid$b_high), 'b_high'] <- tab[3] / sum(tab)
sum(is.na(valid$m_low))
names(train)
names(valid)
varnames <- setdiff(names(train), c("listing_id", "cat", "manager_id", "building_id",
"m_high", "b_high"))
features <- setdiff(varnames, 'interest_level')
varnames
train.hex <- as.h2o(train)
h2o_gbm <- h2o.gbm(x = features, y = "interest_level", train.hex, seed = 10000)
#h2o_gbm <- h2o.gbm(1:5, 6, train.hex, seed = 10000)
true_interest <- valid$interest_level
valid1 <- valid %>%
select(-interest_level)
valid.hex <- as.h2o(valid1)
predH2o <- as.data.frame(h2o.predict(h2o_gbm, valid.hex))
pred <- predH2o$predict
table(true_interest, pred)
library(h2o)
h2o.init(nthreads = -1, max_mem_size="10g")
train.hex <- as.h2o(train)
h2o_gbm <- h2o.gbm(x = features, y = "interest_level", train.hex, seed = 10000)
#h2o_gbm <- h2o.gbm(1:5, 6, train.hex, seed = 10000)
true_interest <- valid$interest_level
valid1 <- valid %>%
select(-interest_level)
valid.hex <- as.h2o(valid1)
predH2o <- as.data.frame(h2o.predict(h2o_gbm, valid.hex))
pred <- predH2o$predict
table(true_interest, pred)
valid_result1 <- cbind(valid, predH2o)
valid_result <- valid_result1 %>%
select(listing_id, interest_level, predict, high, medium, low) %>%
mutate(totalProb = high + medium + low)
print(logloss(valid_result))
names(valid.hex)
features
varnames <- setdiff(names(train), c("listing_id", "cat", "manager_id", "building_id",
"m_high", "m_medium", "m_low",
"b_high", "b_medium", "b_low"))
features <- setdiff(varnames, 'interest_level')
#train1 <- as.data.frame(train)
train.hex <- as.h2o(train)
h2o_gbm <- h2o.gbm(x = features, y = "interest_level", train.hex, seed = 10000)
#h2o_gbm <- h2o.gbm(1:5, 6, train.hex, seed = 10000)
true_interest <- valid$interest_level
valid1 <- valid %>%
select(-interest_level)
valid.hex <- as.h2o(valid1)
predH2o <- as.data.frame(h2o.predict(h2o_gbm, valid.hex))
pred <- predH2o$predict
table(true_interest, pred)
valid_result1 <- cbind(valid, predH2o)
valid_result <- valid_result1 %>%
select(listing_id, interest_level, predict, high, medium, low) %>%
mutate(totalProb = high + medium + low)
print(logloss(valid_result))
varnames <- setdiff(names(train), c("listing_id", "cat", "manager_id", "building_id",
"m_high",
"b_high", "b_medium", "b_low"))
features <- setdiff(varnames, 'interest_level')
#train1 <- as.data.frame(train)
train.hex <- as.h2o(train)
h2o_gbm <- h2o.gbm(x = features, y = "interest_level", train.hex, seed = 10000)
#h2o_gbm <- h2o.gbm(1:5, 6, train.hex, seed = 10000)
true_interest <- valid$interest_level
valid1 <- valid %>%
select(-interest_level)
valid.hex <- as.h2o(valid1)
predH2o <- as.data.frame(h2o.predict(h2o_gbm, valid.hex))
pred <- predH2o$predict
table(true_interest, pred)
valid_result1 <- cbind(valid, predH2o)
valid_result <- valid_result1 %>%
select(listing_id, interest_level, predict, high, medium, low) %>%
mutate(totalProb = high + medium + low)
print(logloss(valid_result))
varnames <- setdiff(names(train), c("listing_id", "cat", "manager_id", "building_id",
"m_high",
"b_high"))
features <- setdiff(varnames, 'interest_level')
#train1 <- as.data.frame(train)
train.hex <- as.h2o(train)
h2o_gbm <- h2o.gbm(x = features, y = "interest_level", train.hex, seed = 10000)
#h2o_gbm <- h2o.gbm(1:5, 6, train.hex, seed = 10000)
true_interest <- valid$interest_level
valid1 <- valid %>%
select(-interest_level)
valid.hex <- as.h2o(valid1)
predH2o <- as.data.frame(h2o.predict(h2o_gbm, valid.hex))
pred <- predH2o$predict
table(true_interest, pred)
valid_result1 <- cbind(valid, predH2o)
valid_result <- valid_result1 %>%
select(listing_id, interest_level, predict, high, medium, low) %>%
mutate(totalProb = high + medium + low)
print(logloss(valid_result))
varnames <- setdiff(names(train), c("listing_id", "cat", "manager_id", "building_id",
"b_high", "b_medium", "b_low"))
features <- setdiff(varnames, 'interest_level')
#train1 <- as.data.frame(train)
train.hex <- as.h2o(train)
h2o_gbm <- h2o.gbm(x = features, y = "interest_level", train.hex, seed = 10000)
#h2o_gbm <- h2o.gbm(1:5, 6, train.hex, seed = 10000)
true_interest <- valid$interest_level
valid1 <- valid %>%
select(-interest_level)
valid.hex <- as.h2o(valid1)
predH2o <- as.data.frame(h2o.predict(h2o_gbm, valid.hex))
pred <- predH2o$predict
table(true_interest, pred)
valid_result1 <- cbind(valid, predH2o)
valid_result <- valid_result1 %>%
select(listing_id, interest_level, predict, high, medium, low) %>%
mutate(totalProb = high + medium + low)
print(logloss(valid_result))
h2o_rf <- h2o.randomForest(x = features, y = "interest_level", train.hex, seed = 10000)
true_interest <- valid$interest_level
valid1 <- valid %>%
select(-interest_level)
valid.hex <- as.h2o(valid1)
predH2o <- as.data.frame(h2o.predict(h2o_rf, valid.hex))
pred <- predH2o$predict
table(true_interest, pred)
valid_result1 <- cbind(valid, predH2o)
valid_result <- valid_result1 %>%
select(listing_id, interest_level, predict, high, medium, low) %>%
mutate(totalProb = high + medium + low)
print(logloss(valid_result))
install.packages("xgboost")
varnames <- setdiff(names(train), c("listing_id", "cat", "building_id",
"b_high", "b_medium", "b_low"))
features <- setdiff(varnames, 'interest_level')
#train1 <- as.data.frame(train)
train$manager_id <- as.factor(train$manager_id)
valid$manager_id <- as.factor(valid$manager_id)
train.hex <- as.h2o(train)
h2o_gbm <- h2o.gbm(x = features, y = "interest_level", train.hex, seed = 10000)
#h2o_gbm <- h2o.gbm(1:5, 6, train.hex, seed = 10000)
true_interest <- valid$interest_level
valid1 <- valid %>%
select(-interest_level)
valid.hex <- as.h2o(valid1)
predH2o <- as.data.frame(h2o.predict(h2o_gbm, valid.hex))
pred <- predH2o$predict
table(true_interest, pred)
valid_result1 <- cbind(valid, predH2o)
valid_result <- valid_result1 %>%
select(listing_id, interest_level, predict, high, medium, low) %>%
mutate(totalProb = high + medium + low)
print(logloss(valid_result))
varnames <- setdiff(names(train), c("listing_id", "cat", "building_id",
"m_high", "m_medium", "m_low",
"b_high", "b_medium", "b_low"))
features <- setdiff(varnames, 'interest_level')
features
h2o_gbm <- h2o.gbm(x = features, y = "interest_level", train.hex, seed = 10000)
#h2o_gbm <- h2o.gbm(1:5, 6, train.hex, seed = 10000)
true_interest <- valid$interest_level
valid1 <- valid %>%
select(-interest_level)
valid.hex <- as.h2o(valid1)
predH2o <- as.data.frame(h2o.predict(h2o_gbm, valid.hex))
pred <- predH2o$predict
table(true_interest, pred)
valid_result1 <- cbind(valid, predH2o)
valid_result <- valid_result1 %>%
select(listing_id, interest_level, predict, high, medium, low) %>%
mutate(totalProb = high + medium + low)
print(logloss(valid_result))
varnames <- setdiff(names(train), c("listing_id", "cat", "building_id",
"m_high", "m_medium", "m_low",
"b_high", "b_medium", "b_low"))
features <- setdiff(varnames, 'interest_level')
#train1 <- as.data.frame(train)
train$manager_id <- as.factor(train$manager_id)
valid$manager_id <- as.factor(valid$manager_id)
train$building_id <- as.factor(train$building_id)
valid$building_id <- as.factor(valid$building_id)
train.hex <- as.h2o(train)
h2o_gbm <- h2o.gbm(x = features, y = "interest_level", train.hex, seed = 10000)
#h2o_gbm <- h2o.gbm(1:5, 6, train.hex, seed = 10000)
true_interest <- valid$interest_level
valid1 <- valid %>%
select(-interest_level)
valid.hex <- as.h2o(valid1)
predH2o <- as.data.frame(h2o.predict(h2o_gbm, valid.hex))
pred <- predH2o$predict
table(true_interest, pred)
valid_result1 <- cbind(valid, predH2o)
valid_result <- valid_result1 %>%
select(listing_id, interest_level, predict, high, medium, low) %>%
mutate(totalProb = high + medium + low)
print(logloss(valid_result))
varnames <- setdiff(names(train), c("listing_id", "cat",
"m_high", "m_medium", "m_low",
"b_high", "b_medium", "b_low"))
features <- setdiff(varnames, 'interest_level')
h2o_gbm <- h2o.gbm(x = features, y = "interest_level", train.hex, seed = 10000)
#h2o_gbm <- h2o.gbm(1:5, 6, train.hex, seed = 10000)
true_interest <- valid$interest_level
valid1 <- valid %>%
select(-interest_level)
valid.hex <- as.h2o(valid1)
predH2o <- as.data.frame(h2o.predict(h2o_gbm, valid.hex))
pred <- predH2o$predict
table(true_interest, pred)
valid_result1 <- cbind(valid, predH2o)
valid_result <- valid_result1 %>%
select(listing_id, interest_level, predict, high, medium, low) %>%
mutate(totalProb = high + medium + low)
print(logloss(valid_result))
h2o_gbm <- h2o.gbm(x = features
,y = "interest_level"
,training_frame = train.hex
,distribution = "multinomial"
,model_id = "gbm1"
#,nfolds = 5
,ntrees = 750
,learn_rate = 0.05
,max_depth = 7
,min_rows = 20
,sample_rate = 0.7
,col_sample_rate = 0.7
#   ,stopping_rounds = 5
#   ,stopping_metric = "logloss"
#   ,stopping_tolerance = 0
,seed=321
)
true_interest <- valid$interest_level
valid1 <- valid %>%
select(-interest_level)
valid.hex <- as.h2o(valid1)
predH2o <- as.data.frame(h2o.predict(h2o_gbm, valid.hex))
pred <- predH2o$predict
table(true_interest, pred)
valid_result1 <- cbind(valid, predH2o)
valid_result <- valid_result1 %>%
select(listing_id, interest_level, predict, high, medium, low) %>%
mutate(totalProb = high + medium + low)
print(logloss(valid_result))
final_df <- data_df %>%
left_join(word_cnt) %>%
left_join(sentiment) %>%
left_join(pet_df) %>%
left_join(laundry_df) %>%
left_join(pool_df) %>%
left_join(fee_df) %>%
left_join(dishwasher_df)
final_df[is.na(final_df$word_cnt), 'word_cnt'] <- 0
final_df[is.na(final_df$sentiment), 'sentiment'] <- 0
final_df[is.na(final_df$pet), 'pet'] <- 0
final_df[is.na(final_df$laundry), 'laundry'] <- 0
final_df[is.na(final_df$pool), 'pool'] <- 0
final_df[is.na(final_df$fee), 'fee'] <- 0
final_df[is.na(final_df$dishwasher), 'dishwasher'] <- 0
final_df$word_cnt <- as.factor(final_df$word_cnt)
final_df$sentiment <- as.factor(final_df$sentiment)
final_df$pet <- as.factor(final_df$pet)
final_df$laundry <- as.factor(final_df$laundry)
final_df$pool <- as.factor(final_df$pool)
final_df$fee <- as.factor(final_df$fee)
final_df$dishwasher <- as.factor(final_df$dishwasher)
final_df$numphotos <- unlist(map(final_df$photos, function(p) length(unlist(p))))
final_df$numfeatures <- unlist(map(final_df$features, function(p) length(unlist(p))))
final_df <- final_df %>%
select(cat, listing_id, bathrooms, bedrooms, latitude, longitude,
price, month, ten_day, word_cnt, sentiment, pet, laundry,
pool, fee, dishwasher, numphotos, numfeatures, interest_level,
manager_id, building_id) %>%
filter(cat == 'test' | price < 50000) %>%
mutate(logprice = log(price))
names(final_df)
train <- train_df[split,]
valid <- train_df[!split, ]
final_df <- data_df %>%
left_join(word_cnt) %>%
left_join(sentiment) %>%
left_join(pet_df) %>%
left_join(laundry_df) %>%
left_join(pool_df) %>%
left_join(fee_df) %>%
left_join(dishwasher_df)
final_df[is.na(final_df$word_cnt), 'word_cnt'] <- 0
final_df[is.na(final_df$sentiment), 'sentiment'] <- 0
final_df[is.na(final_df$pet), 'pet'] <- 0
final_df[is.na(final_df$laundry), 'laundry'] <- 0
final_df[is.na(final_df$pool), 'pool'] <- 0
final_df[is.na(final_df$fee), 'fee'] <- 0
final_df[is.na(final_df$dishwasher), 'dishwasher'] <- 0
final_df$word_cnt <- as.factor(final_df$word_cnt)
final_df$sentiment <- as.factor(final_df$sentiment)
final_df$pet <- as.factor(final_df$pet)
final_df$laundry <- as.factor(final_df$laundry)
final_df$pool <- as.factor(final_df$pool)
final_df$fee <- as.factor(final_df$fee)
final_df$dishwasher <- as.factor(final_df$dishwasher)
final_df$manager_id <- as.factor(final_df$manager_id)
final_df$building_id <- as.factor(final_df$building_id)
final_df$numphotos <- unlist(map(final_df$photos, function(p) length(unlist(p))))
final_df$numfeatures <- unlist(map(final_df$features, function(p) length(unlist(p))))
final_df <- final_df %>%
select(cat, listing_id, bathrooms, bedrooms, latitude, longitude,
price, month, ten_day, word_cnt, sentiment, pet, laundry,
pool, fee, dishwasher, numphotos, numfeatures, interest_level,
manager_id, building_id) %>%
filter(cat == 'test' | price < 50000) %>%
mutate(logprice = log(price))
train_df <- final_df %>%
filter(cat == 'train')
train <- train_df[split,]
valid <- train_df[!split, ]
names(train)
varnames <- setdiff(names(train), c("listing_id", "cat"))
# "m_high", "m_medium", "m_low",
# "b_high", "b_medium", "b_low"))
features <- setdiff(varnames, 'interest_level')
#train1 <- as.data.frame(train)
features
train.hex <- as.h2o(train)
h2o_gbm <- h2o.gbm(x = features, y = "interest_level", train.hex, seed = 10000)
true_interest <- valid$interest_level
valid1 <- valid %>%
select(-interest_level)
valid.hex <- as.h2o(valid1)
predH2o <- as.data.frame(h2o.predict(h2o_gbm, valid.hex))
pred <- predH2o$predict
table(true_interest, pred)
valid_result1 <- cbind(valid, predH2o)
valid_result <- valid_result1 %>%
select(listing_id, interest_level, predict, high, medium, low) %>%
mutate(totalProb = high + medium + low)
print(logloss(valid_result))
q()
